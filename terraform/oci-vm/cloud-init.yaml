#cloud-config
# =============================================================================
# MCP OCI OPSI Server - Cloud-Init Configuration
# =============================================================================
# This cloud-init configuration provisions an OCI Compute instance with all
# prerequisites for running the MCP OCI OPSI Server.
# =============================================================================

# -----------------------------------------------------------------------------
# Package Management
# -----------------------------------------------------------------------------

package_update: true
package_upgrade: true

packages:
  # Python and development tools
  - python39
  - python39-pip
  - python39-devel
  - gcc
  - make
  - git
  # Docker prerequisites
  - yum-utils
  - device-mapper-persistent-data
  - lvm2
  # Utilities
  - jq
  - curl
  - wget
  - unzip
  - vim
  - htop

# -----------------------------------------------------------------------------
# User and Group Configuration
# -----------------------------------------------------------------------------

groups:
  - docker

users:
  - default
  - name: mcp
    groups: [docker]
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    home: /home/mcp

# -----------------------------------------------------------------------------
# File Creation
# -----------------------------------------------------------------------------

write_files:
  # OCI CLI config directory
  - path: /home/mcp/.oci/.gitkeep
    permissions: '0700'
    owner: mcp:mcp
    content: ""

  # OCI config file (if provided)
  %{ if oci_config_content != "" }
  - path: /home/mcp/.oci/config
    permissions: '0600'
    owner: mcp:mcp
    encoding: b64
    content: ${oci_config_content}
  %{ endif }

  # OCI API key (if provided)
  %{ if oci_key_content != "" }
  - path: /home/mcp/.oci/oci_api_key.pem
    permissions: '0600'
    owner: mcp:mcp
    encoding: b64
    content: ${oci_key_content}
  %{ endif }

  # MCP server environment file
  - path: /opt/mcp-oci-opsi/.env
    permissions: '0600'
    owner: mcp:mcp
    content: |
      # MCP OCI OPSI Server Configuration
      # Generated by Terraform cloud-init

      # Server Configuration
      MCP_VERSION=${mcp_version}
      MCP_TRANSPORT=${mcp_transport}
      MCP_HTTP_HOST=0.0.0.0
      MCP_HTTP_PORT=${mcp_http_port}
      MCP_DEBUG=0

      # OCI Configuration
      OCI_CLI_PROFILE=${oci_cli_profile}
      OCI_REGION=${region}

      # OAuth Configuration (if enabled)
      %{ if enable_oauth }
      FASTMCP_OAUTH_ENABLED=1
      FASTMCP_SERVER_AUTH_OCI_CONFIG_URL=${oauth_config_url}
      FASTMCP_SERVER_AUTH_OCI_CLIENT_ID=${oauth_client_id}
      FASTMCP_SERVER_AUTH_OCI_CLIENT_SECRET=${oauth_client_secret}
      FASTMCP_SERVER_BASE_URL=${server_base_url}
      # JWT_SIGNING_KEY and STORAGE_ENCRYPTION_KEY will be generated
      %{ else }
      FASTMCP_OAUTH_ENABLED=0
      %{ endif }

  # Systemd service file
  - path: /etc/systemd/system/mcp-oci-opsi.service
    permissions: '0644'
    content: |
      [Unit]
      Description=MCP OCI OPSI Server
      Documentation=https://github.com/adibirzu/mcp_oci_opsi
      After=network-online.target docker.service
      Wants=network-online.target

      [Service]
      Type=simple
      User=mcp
      Group=mcp
      WorkingDirectory=/opt/mcp-oci-opsi
      EnvironmentFile=/opt/mcp-oci-opsi/.env
      ExecStart=/opt/mcp-oci-opsi/.venv/bin/python -m mcp_oci_opsi
      Restart=always
      RestartSec=10
      StandardOutput=journal
      StandardError=journal

      # Security hardening
      NoNewPrivileges=true
      ProtectSystem=strict
      ProtectHome=read-only
      ReadWritePaths=/opt/mcp-oci-opsi /home/mcp/.mcp_oci_opsi
      PrivateTmp=true

      [Install]
      WantedBy=multi-user.target

  # Docker Compose file (alternative deployment method)
  - path: /opt/mcp-oci-opsi/docker-compose.override.yml
    permissions: '0644'
    owner: mcp:mcp
    content: |
      version: '3.8'
      services:
        mcp-oci-opsi:
          environment:
            - MCP_VERSION=${mcp_version}
            - MCP_TRANSPORT=${mcp_transport}
            - MCP_HTTP_PORT=${mcp_http_port}
            - OCI_CLI_PROFILE=${oci_cli_profile}
            - OCI_REGION=${region}
            %{ if enable_oauth }
            - FASTMCP_OAUTH_ENABLED=1
            - FASTMCP_SERVER_AUTH_OCI_CONFIG_URL=${oauth_config_url}
            - FASTMCP_SERVER_AUTH_OCI_CLIENT_ID=${oauth_client_id}
            - FASTMCP_SERVER_AUTH_OCI_CLIENT_SECRET=${oauth_client_secret}
            - FASTMCP_SERVER_BASE_URL=${server_base_url}
            %{ endif }
          volumes:
            - /home/mcp/.oci:/home/mcp/.oci:ro

  # Setup completion marker script
  - path: /opt/mcp-oci-opsi/setup-complete.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      echo "=================================="
      echo "MCP OCI OPSI Server Setup Complete"
      echo "=================================="
      echo ""
      echo "Server Status:"
      systemctl status mcp-oci-opsi --no-pager
      echo ""
      echo "View logs with: sudo journalctl -u mcp-oci-opsi -f"
      echo ""
      %{ if mcp_transport == "http" }
      echo "Server URL: http://$(hostname -I | awk '{print $1}'):${mcp_http_port}"
      %{ endif }

# -----------------------------------------------------------------------------
# Run Commands
# -----------------------------------------------------------------------------

runcmd:
  # Set up Python alternatives
  - alternatives --set python3 /usr/bin/python3.9
  - alternatives --install /usr/bin/pip3 pip3 /usr/bin/pip3.9 1

  # Install Docker
  - yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
  - yum install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
  - systemctl enable docker
  - systemctl start docker
  - usermod -aG docker mcp
  - usermod -aG docker opc

  # Install OCI CLI
  - |
    curl -L https://raw.githubusercontent.com/oracle/oci-cli/master/scripts/install/install.sh | \
    bash -s -- --accept-all-defaults --install-dir /opt/oci-cli
  - ln -sf /opt/oci-cli/bin/oci /usr/local/bin/oci

  # Create application directory
  - mkdir -p /opt/mcp-oci-opsi
  - chown -R mcp:mcp /opt/mcp-oci-opsi

  # Clone repository
  - |
    su - mcp -c "git clone --branch ${github_branch} ${github_repo_url} /opt/mcp-oci-opsi/repo"
  - |
    su - mcp -c "cp -r /opt/mcp-oci-opsi/repo/* /opt/mcp-oci-opsi/"
  - rm -rf /opt/mcp-oci-opsi/repo

  # Create virtual environment and install dependencies
  - |
    su - mcp -c "cd /opt/mcp-oci-opsi && python3 -m venv .venv"
  - |
    su - mcp -c "cd /opt/mcp-oci-opsi && .venv/bin/pip install --upgrade pip"
  - |
    su - mcp -c "cd /opt/mcp-oci-opsi && .venv/bin/pip install -e ."

  # Generate security keys if OAuth is enabled
  %{ if enable_oauth }
  - |
    JWT_KEY=$(python3 -c "import secrets; print(secrets.token_hex(32))")
    ENCRYPT_KEY=$(python3 -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())")
    echo "JWT_SIGNING_KEY=$JWT_KEY" >> /opt/mcp-oci-opsi/.env
    echo "STORAGE_ENCRYPTION_KEY=$ENCRYPT_KEY" >> /opt/mcp-oci-opsi/.env
  %{ endif }

  # Set up OCI config if not provided
  %{ if oci_config_content == "" }
  - |
    # Create a placeholder OCI config - user needs to configure this
    cat > /home/mcp/.oci/config << 'OCICONFIG'
    [DEFAULT]
    # Replace with your OCI configuration
    # user=ocid1.user.oc1..your-user-ocid
    # tenancy=ocid1.tenancy.oc1..your-tenancy-ocid
    # region=${region}
    # fingerprint=xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx:xx
    # key_file=/home/mcp/.oci/oci_api_key.pem
    OCICONFIG
    chown mcp:mcp /home/mcp/.oci/config
    chmod 600 /home/mcp/.oci/config
  %{ endif }

  # Create cache directory
  - mkdir -p /home/mcp/.mcp_oci_opsi
  - chown -R mcp:mcp /home/mcp/.mcp_oci_opsi

  # Fix permissions
  - chown -R mcp:mcp /opt/mcp-oci-opsi
  - chown -R mcp:mcp /home/mcp/.oci

  # Enable and start MCP service
  - systemctl daemon-reload
  - systemctl enable mcp-oci-opsi
  - systemctl start mcp-oci-opsi

  # Run setup completion script
  - /opt/mcp-oci-opsi/setup-complete.sh

# -----------------------------------------------------------------------------
# Final Message
# -----------------------------------------------------------------------------

final_message: |
  MCP OCI OPSI Server provisioning complete!

  Cloud-init completed in $UPTIME seconds.

  Check service status: sudo systemctl status mcp-oci-opsi
  View logs: sudo journalctl -u mcp-oci-opsi -f

  %{ if mcp_transport == "http" }
  HTTP endpoint: http://$(hostname -I | awk '{print $1}'):${mcp_http_port}
  %{ endif }
